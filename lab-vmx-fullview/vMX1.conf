# -*- junos -*-
system {
    host-name vMX1;
}

interfaces {
    ge-0/0/0 {
        unit 0 {
            family inet {
                address 192.0.2.1/31;
            }
        }
    }
    ge-0/0/1 {
        unit 0 {
            family inet {
                address 192.0.2.128/31;
            }
        }
    }
}

routing-options {
    router-id 192.0.2.128;
    autonomous-system 64512;
    replace: forwarding-table {
        export [ LOAD-BALANCE NOT-FROM-BGP BGP-OPTIMIZE ];
    }
}

protocols {
    replace: bgp {
        log-updown;
        preference 140;
        group v4-UPSTREAM {
            type external;
            import v4-PUBLIC-BGP;
            export v4-PUBLIC-OUR;
            peer-as 65001;
            neighbor 192.0.2.0;
        }
        group v4-IBGP {
            type internal;
            export NEXT-HOP-SELF;
            peer-as 64512;
            neighbor 192.0.2.129;
        }
    }
    replace: ospf {
        export v4-PUBLIC-REDISTRIBUTE-OSPF;
        area 0.0.0.0 {
            interface ge-0/0/1.0;
        }
    }
}

replace: policy-options {
    policy-statement LOAD-BALANCE {
        then {
            load-balance per-packet;
        }
    }
    policy-statement NOT-FROM-BGP {
        /* Accept any route not from BGP */
        term 1 {
            from protocol bgp;
            then next policy;
        }
        then accept;
    }
    policy-statement BGP-OPTIMIZE {
        /* Optimize routes from BGP */
        term 1 {
            /* Accept the default */
            from {
                protocol bgp;
                route-filter 0.0.0.0/0 exact;
            }
            then accept;
        }
        term 2 {
            /* Reject /25 or smaller */
            from {
                protocol bgp;
                route-filter 0.0.0.0/0 prefix-length-range /25-/32;
            }
            then reject;
        }
        term 3 {
            # Reject /17 or smaller when next-hop is same as
            # default. First if the next-hop is our upstream.
            from {
                protocol bgp;
                route-filter 0.0.0.0/0 prefix-length-range /17-/32;
                next-hop 192.0.2.0;
                # Unfortunately, we have to assume the default route
                # is present since the condition system is not
                # powerful enough. This should be a fair assumption as
                # we have a non-default route from the same upstream.
                inactive: condition default-to-upstream;
            }
            then reject;
        }
        inactive: term 4 {
            # Reject /17 or smaller when next-hop is same as default...
            from {
                protocol bgp;
                route-filter 0.0.0.0/0 prefix-length-range /17-/32;
                next-hop 192.0.2.129;
                # We have to ensure that the default is set to
                # 192.0.2.129. Won't work otherwise.
                inactive: condition default-to-peer;
            }
            then reject;
        }
        term 100 {
            /* Accept the remaining */
            from protocol bgp;
            then accept;
        }
    }
    policy-statement NEXT-HOP-SELF {
        term 1 {
            from protocol bgp;
            then {
                next-hop self;
            }
        }
    }
    policy-statement v4-PUBLIC-BGP {
        /* Accept anything */
        then {
            metric 10;
            local-preference 100;
            accept;
        }
    }
    policy-statement v4-PUBLIC-OUR {
        term 1 {
            /* Filter out default route or too long prefix length */
            from {
                family inet;
                route-filter 0.0.0.0/0 exact;
                route-filter 0.0.0.0/0 prefix-length-range /25-/32;
            }
            then reject;
        }
        term 10 {
            /* Accept anything from our prefix range */
            from {
                family inet;
                route-filter 203.0.113.0/24 orlonger;
            }
            then {
                metric 0;
                accept;
            }
        }
    }
    policy-statement v4-PUBLIC-REDISTRIBUTE-OSPF {
        term 10 {
            /* Default route from eBGP */
            from {
                family inet;
                protocol bgp;
                route-filter 0.0.0.0/0 exact;
                route-type external;
            }
            then {
                metric 10;
                external {
                    type 2;
                }
                accept;
            }
        }
        term 11 {
            /* Default route from iBGP */
            from {
                family inet;
                protocol bgp;
                route-filter 0.0.0.0/0 exact;
                route-type internal;
            }
            then {
                metric 20;
                external {
                    type 2;
                }
                accept;
            }
        }
    }
}
