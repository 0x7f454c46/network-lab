#!/bin/sh

cd "$(dirname "$(readlink -f "$0")")"
. ../common/lab-setup

spawn vm R1 network 1

run

loops=6
perloop=12
n1=1-9
n2=6-5

name() {
    case $1 in
        $n1) echo n1 ;;
        $n2) echo n2 ;;
        *) echo $1 ;;
    esac
}
link() {
    from=$1
    to=$2
    ip link add name $from--$to type veth peer $to--$from
    ip link set up dev $from--$to
    ip link set up dev $to--$from
    ip link set $from--$to master br-$from
    ip link set $to--$from master br-$to
}

service mstpd -s
cat <<EOF > /sbin/bridge-stp
#!/bin/sh
exit 0
EOF
chmod +x /sbin/bridge-stp

for loop in $(seq 1 $loops); do
    for switch in $(seq 1 $perloop); do
        case $loop-$switch in
            $n1)
                priority=1
                ;;
            $n2)
                priority=2
                ;;
            *)
                priority=8
                ;;
        esac
        ip link add name br-$(name $loop-$switch) type bridge stp_state 1
        mstpctl addbridge br-$(name $loop-$switch)
        mstpctl settreeprio br-$(name $loop-$switch) 0 $priority
        ip link set up dev br-$(name $loop-$switch)
    done
    for switch in $(seq 1 $perloop); do
        from=$(name $loop-$switch)
        to=$(name $loop-$((switch%perloop + 1)))
        link $from $to
    done
done
for loop in $(seq 1 $((loops-1))); do
    for switch in ${n1#*-} ${n2#*-}; do
        from=$(name $loop-$switch)
        to=$(name $((loop+1))-$switch)
        link $from $to
    done
done
