#!/bin/sh

cd "$(dirname "$(readlink -f "$0")")"
. ../common/lab-setup

# Which VM to spawn
spawn vm H1 network 2
spawn vm R1 network 1,2
spawn vm R2 network 1,3
spawn vm H2 network 3

run

# Executed on each VM
case $uts in
    R*)
        ip addr add 2001:db8::1${uts#R}/64 dev eth0
        ip addr add 2001:db8:${uts#R}::1/64 dev eth1
        ip -6 route add 2001:db8:$(( 3-${uts#R} ))::/64 via 2001:db8::1$(( 3-${uts#R} ))
        sysctl -qw net/ipv4/ip_forward=1
        sysctl -qw net/ipv6/conf/all/forwarding=1
        ;;
    H*)
        ip addr add 2001:db8:${uts#H}::10/64 dev eth0
        ip addr add 203.0.113.1${uts#H}/32 dev dummy0
        ip -6 route add default via 2001:db8:${uts#H}::1
        ip route add 203.0.113.1$(( 3-${uts#H} )) via inet6 2001:db8:${uts#H}::1
        service nginx
        ;;
esac
